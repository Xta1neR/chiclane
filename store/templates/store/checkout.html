{% extends "store/base.html" %}
{% block title %}Checkout{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-8">
  <h1 class="text-3xl font-bold mb-6 text-center">Checkout</h1>

  <div class="card p-6 space-y-6">

    <!-- Shipping Details -->
    <div>
      <h2 class="text-xl font-semibold mb-4">Shipping Details</h2>

      <form method="post" id="checkoutForm">
        {% csrf_token %}

        <!-- Name -->
        <div class="mb-4">
          <label class="block font-semibold text-gray-700">Name</label>
          <input type="text" name="full_name" 
                 value="{{ form.full_name.value|default_if_none:request.user.profile.full_name }}"
                 class="w-full border rounded-lg px-3 py-2 text-gray-700 bg-gray-100" readonly>
        </div>

        <!-- Phone -->
        <div class="mb-4">
          <label class="block font-semibold text-gray-700">Phone</label>
          <input type="text" name="phone_number" 
                 value="{{ form.phone_number.value|default_if_none:request.user.profile.phone_number }}"
                 class="w-full border rounded-lg px-3 py-2 text-gray-700 bg-gray-100" readonly>
        </div>

        <!-- Address -->
        <div class="mb-4">
          <label class="block font-semibold text-gray-700">Address</label>
          <textarea name="address" rows="3"
                    class="w-full border rounded-lg px-3 py-2 text-gray-700 bg-gray-100" readonly>{{ form.address.value|default_if_none:request.user.profile.address }}</textarea>
        </div>

        <!-- Coupon -->
        <div class="mb-4">
          <label class="block font-semibold text-gray-700">Coupon Code</label>
          <div class="flex gap-2">
            <input type="text" name="code"  value="{% if applied_coupon %}{{ applied_coupon.code }}{% endif %}"  
                   class="w-full border rounded-lg px-3 py-2 text-gray-700" placeholder="Enter coupon code">
            <button type="submit" name="apply_coupon"
                    class="px-4 py-2 rounded-lg bg-yellow-500 text-black font-semibold hover:bg-yellow-400">
              Apply
            </button>
          </div>
        </div>

        <!-- Order Summary -->
        {% if cart_items %}
        <div class="mb-4">
          <h2 class="text-xl font-semibold mb-4">Order Summary</h2>
          <div class="space-y-2">
            {% for item in cart_items %}
            <div class="flex justify-between text-sm">
              <div>{{ item.variant.product.name }} ({{ item.variant.size }}) × {{ item.quantity }}</div>
              <div class="font-semibold">₹{{ item.line_total }}</div>
            </div>
            {% endfor %}
          </div>

          <div class="mt-4 text-right space-y-1">
            <div>Total: <span class="text-gray-300">₹{{ total }}</span></div>
            {% if discount > 0 %}
            <div>Discount: <span class="text-green-400">-₹{{ discount }}</span></div>
            {% endif %}
            <div class="font-bold text-lg">Final Total: <span class="text-yellow-600">₹{{ final_total }}</span></div>
          </div>
        </div>
        {% endif %}

        <!-- Buttons -->
        <div class="flex flex-col md:flex-row items-center justify-between gap-4 mt-4">
          <button type="button" id="editBtn"
                  class="w-full md:w-auto px-6 py-3 rounded-lg bg-gray-200 text-gray-700 font-semibold hover:bg-gray-300 transition">
            Edit Details
          </button>

          <button type="submit" name="place_order"
                  class="btn-gold w-full md:w-auto px-6 py-3 rounded-lg font-semibold shadow-md">
            Place Order
          </button>
        </div>
      </form>
    </div>

  </div>
</div>

<script>
  const editBtn = document.getElementById("editBtn");
  const formInputs = document.querySelectorAll("#checkoutForm input[name='full_name'], #checkoutForm input[name='phone_number'], #checkoutForm textarea[name='address']");

  editBtn.addEventListener("click", function () {
    formInputs.forEach(el => {
      if (el.hasAttribute("readonly")) {
        el.removeAttribute("readonly");
        el.classList.remove("bg-gray-100");
        el.classList.add("bg-white");
      } else {
        el.setAttribute("readonly", true);
        el.classList.remove("bg-white");
        el.classList.add("bg-gray-100");
      }
    });

    // Toggle button text
    editBtn.innerText = (editBtn.innerText === "Edit Details") ? "Lock Details" : "Edit Details";
  });
</script>
{% endblock %}
